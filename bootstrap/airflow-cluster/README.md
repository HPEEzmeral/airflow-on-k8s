# AirflowCluster

## Variables

* `AIRGAP_REGISTRY` - address of docker registry for airgapped env, e.g. `localhost:5000/` (Trailing slash is needed). If env is not airgapped, set empty string as value;

* `AIRFLOW_BASE_NAMESPACE` - name of namespace, where AirflowBase is running;

* `AIRFLOW_CLUSTER_NAMESPACE` - name of namespace for AirflowCluster. This namespace should exists on cluster;

* `AIRFLOW_CLUSTER_IMAGE_TAG` - tag of Airflow docker image. Set new tag to update the operator. Use `develop-latest` as default value;

* `AIRFLOW_GIT_REPO_URL` - URL of git repository with DAGs. Use `https://github.com/akravacyber/spark-airflow.git` as default value;

* `AIRFLOW_GIT_REPO_BRANCH` - branch of git repository, which should be used to access DAGs. Use `master` as default value; 

* `AIRFLOW_GIT_REPO_SUBDIR` - path to directory, where DAGs are placed in git repository. Use `example_dags/` as default value;

* `GIT_PROXY_HTTP` - Address of HTTP proxy for git-sync container. Set empty string as default value;

* `GIT_PROXY_HTTPS` - Address of HTTPS proxy for git-sync container. Set empty string as default value;

* `AIRFLOW_GIT_REPO_USER` (not required) - Username to use for git auth;

* `AIRFLOW_GIT_REPO_CRED_SECRET_NAME` (not required) - Password or personal access token to use for git auth;

* `GIT_CERT_SECRET_NAME` (not required) - name of secret in the `AIRFLOW_CLUSTER_NAMESPACE` namespace, where ssl certificate of git repository is stored.

## Requirements

* version of `kubectl` should be 1.14 or above;

* Airflow operator should be in running state;

* AirflowBase should be in running state and name of namespace, where it is running, should be equal to value of `AIRFLOW_BASE_NAMESPACE` env variable;

* namespace, which name is set in `AIRFLOW_CLUSTER_NAMESPACE` env variable, should exists. If not, refer to instructions in `Install` section to fix it;

* secret `hpecp-ext-auth-secret` in namespace `hpecp` should exists. This secret is generated by HPE platform. If not, refer to `Install` section to fix it;

* there is should be a corresponding tenant resource within the selected namespace.

## Install

All variables should be set into env.

If namesapce, which name is set in `AIRFLOW_CLUSTER_NAMESPACE` env variable, doesn't exists, run such command:

```bash
kubectl create ns $AIRFLOW_CLUSTER_NAMESPACE
```

If namespace `hpecp` desn't exists, create it with such commnad:

```bash
kubectl create ns hpecp
```

If secret `hpecp-ext-auth-secret` in namespace `hpecp` doesn't exists, execute such command (you should pass data about LDAP server in env variables, which are described in README.md in `airflow-on-k8s/bootstrap/hpecp-ext-auth-secret` directory):

```bash
auth_service_locations="127.0.0.1:383" base_dn="ou=users,dc=example,dc=com" bind_dn="cn=admin,dc=example,dc=com" bind_pwd="admin" user_attr="uid" kubectl apply -k airflow-on-k8s/bootstrap/hpecp-ext-auth-secret
```

AirflowCluster installation depends on type of git repository:

* If git repository is public, use such command to install AirflowCluster:

    ```bash
    AIRGAP_REGISTRY="" AIRFLOW_BASE_NAMESPACE="airflow-base" AIRFLOW_CLUSTER_NAMESPACE="default" AIRFLOW_CLUSTER_IMAGE_TAG="develop-latest" AIRFLOW_GIT_REPO_URL="https://github.com/akravacyber/spark-airflow.git" AIRFLOW_GIT_REPO_BRANCH="master" AIRFLOW_GIT_REPO_SUBDIR="example_dags/" GIT_PROXY_HTTP="" GIT_PROXY_HTTPS="" kubectl apply -k airflow-on-k8s/bootstrap/airflow-cluster/overlays/public-repo
    ```

* If git repository is private, we need to pass username in `AIRFLOW_GIT_REPO_USER` variable and password (or access token) in secret by key `password` within `AIRFLOW_CLUSTER_NAMESPACE` namespace.

    * If the password (or access token) of git repository is already stored in secret by key `password` within `AIRFLOW_CLUSTER_NAMESPACE` namespace, let's additionally pass it name in `AIRFLOW_GIT_REPO_CRED_SECRET_NAME` variable (and of course we need to pass username in `AIRFLOW_GIT_REPO_USER` variable): 

        ```bash
        AIRGAP_REGISTRY="" AIRFLOW_BASE_NAMESPACE="airflow-base" AIRFLOW_CLUSTER_NAMESPACE="default" AIRFLOW_CLUSTER_IMAGE_TAG="develop-latest" AIRFLOW_GIT_REPO_URL="https://github.com/akravacyber/private-spark-airflow.git" AIRFLOW_GIT_REPO_BRANCH="master" AIRFLOW_GIT_REPO_SUBDIR="example_dags/" GIT_PROXY_HTTP="" GIT_PROXY_HTTPS="" AIRFLOW_GIT_REPO_USER="mapr" AIRFLOW_GIT_REPO_CRED_SECRET_NAME="secret-with-git-creds" kubectl apply -k airflow-on-k8s/bootstrap/airflow-cluster/overlays/private-repo-secret
        ```

    * If the password (or access token) is not already stored in secret, we can pass it in `password` env variable, so appropriate secret will be generated:

        ```bash
        AIRGAP_REGISTRY="" AIRFLOW_BASE_NAMESPACE="airflow-base" AIRFLOW_CLUSTER_NAMESPACE="default" AIRFLOW_CLUSTER_IMAGE_TAG="develop-latest" AIRFLOW_GIT_REPO_URL="https://github.com/akravacyber/private-spark-airflow.git" AIRFLOW_GIT_REPO_BRANCH="master" AIRFLOW_GIT_REPO_SUBDIR="example_dags/" GIT_PROXY_HTTP="" GIT_PROXY_HTTPS="" AIRFLOW_GIT_REPO_USER="mapr" password="mapr" kubectl apply -k airflow-on-k8s/bootstrap/airflow-cluster/overlays/private-repo-password
        ```

### Install with shell script

* We can install AirflowCluster with public git repository by executing such shell script:

    ```bash
    AIRFLOW_GIT_REPO_URL="https://github.com/akravacyber/spark-airflow.git" AIRFLOW_GIT_REPO_SUBDIR="example_dags/" /bin/sh airflow-on-k8s/bootstrap/airflow-cluster/install.sh
    ```

* We can install AirflowCluster with private git repository in two ways:

    * If the password (or access token) of git repository is already stored in secret by key `password` within `AIRFLOW_CLUSTER_NAMESPACE` namespace, let's additionally pass it name in `AIRFLOW_GIT_REPO_CRED_SECRET_NAME` variable (and of course we need to pass username in `AIRFLOW_GIT_REPO_USER` variable):

        ```bash
        AIRFLOW_GIT_REPO_URL="https://github.com/akravacyber/private-spark-airflow.git" AIRFLOW_GIT_REPO_SUBDIR="example_dags/" AIRFLOW_GIT_REPO_USER="mapr" AIRFLOW_GIT_REPO_CRED_SECRET_NAME="secret-with-git-creds" /bin/sh airflow-on-k8s/bootstrap/airflow-cluster/install.sh
        ```

    * If the password (or access token) is not already stored in secret, we can pass creds in prompt and script below will generate appropriate secret. So we need only to pass username in `AIRFLOW_GIT_REPO_USER` variable. Then we can execute such command and after that pass creds in prompt:

        ```bash
        AIRFLOW_GIT_REPO_URL="https://github.com/akravacyber/private-spark-airflow.git" AIRFLOW_GIT_REPO_SUBDIR="example_dags/" AIRFLOW_GIT_REPO_USER="mapr" /bin/sh airflow-on-k8s/bootstrap/airflow-cluster/install.sh
        ```

We can customize installation with the same env variables, as above.

We need to set `AIRFLOW_GIT_REPO_URL` env variable with some non-empty value. In otherwise, there will be an error during installation.

By default, for any git repository with HTTPS protocol SSL certs are not verified. In order to verify git SSL certs, create secret with private and public keys of SSL certificate in the current namespace, where AirflowCluster is going to be installed. After that pass the name of this secret in the `GIT_CERT_SECRET_NAME` env variable during installation.

If needed env variables aren't provided, default values will be used. 

## Upgrade

We can upgrade single instance of Airflow Clsuter by executing such shell script:

```bash
AIRFLOW_CLUSTER_IMAGE_TAG="<place_here_new_tag>" AIRFLOW_CLUSTER_NAMESPACE="default" /bin/sh airflow-on-k8s/bootstrap/airflow-cluster/upgrade.sh
```

We need to pass new tag of Airflow Cluster in `AIRFLOW_CLUSTER_IMAGE_TAG` env variable. Also we need to pass name of namespace, where desired to upgrade Airflow Cluster is installed, in `AIRFLOW_CLUSTER_NAMESPACE` env variable. If these two env variables are not set, script will be failed with error.

Also we can pass `AIRGAP_REGISTRY`, `AIRFLOW_GIT_REPO_URL`, `AIRFLOW_GIT_REPO_BRANCH`, `AIRFLOW_GIT_REPO_SUBDIR`, `GIT_PROXY_HTTP`, `GIT_PROXY_HTTPS`, `GIT_CERT_SECRET_NAME` env variables to override previous settings.

If `AIRFLOW_CLUSTER_UPGRADE_SET_NEW_GIT_CRED` env variable is set to value `true`, we can also override previous settings of git credentials: we can use `AIRFLOW_GIT_REPO_USER` and `AIRFLOW_GIT_REPO_CRED_SECRET_NAME` env variables in the same way, as for installation flow.

## Uninstall

In this command replace `default` with value, which was set for `AIRFLOW_CLUSTER_NAMESPACE` variable during installation:

```bash
kubectl delete airflowcluster af-cluster -n default && kubectl delete cm airflow-cluster-common-cm -n default && kubectl delete secret hpe-imagepull-secrets -n default
```

If secret with creds for private git repository is no longer needed, we should delete it manually.

### Uninstall with shell script

We can uninstall AirflowCluster by executing such shell script:

```bash
/bin/sh airflow-on-k8s/bootstrap/airflow-cluster/uninstall.sh
```

We need to set `AIRFLOW_CLUSTER_NAMESPACE` variable, if it value was different from default one during installation.

If secret with creds for private git repository is no longer needed, we should delete it manually.
